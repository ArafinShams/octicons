<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/primer-css@9.4.0/build/build.css">
  </head>
  <body class="p-responsive py-4 container-md">
    <h1 class="mb-2">Panocticon</h1>
    <p class="f4 text-gray mb-4">
      Change the options to see new images, then click to download.
    </p>

    <div class="d-block d-md-flex">

      <form id="chooser" class="mb-4">
        <h3 class="mb-2">Options</h3>

        <table class="width-full">

          <tr>
            <th class="text-left pr-4">
              <label for="symbol">Octicon</label>
            </th>
            <td>
              <select id="symbol" class="form-select input-block my-2">
                {% for octicon in icons %}
                  <option>{{ octicon.symbol }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>

          <tr>
            <th class="text-left pr-4">
              <label for="color">Color</label>
            </th>
            <td>
              <select id="color" class="form-select input-block my-2">
                {% for color in colors %}
                  <option value="{{ color.name }}">{{ color.name }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>

          <tr>
            <th class="text-left pr-4">
              <b>Size</b>
            </th>
            <td>
              {% for size in sizes %}
                <label class="btn d-inline-block" for="size-{{ size }}">
                  <span class="text-normal">{{ size }}px</span>
                  <input id="size-{{ size }}" class="d-none" type="radio" name="size" value="{{ size }}">
                </label>
              {% endfor %}
            </td>
          </tr>

        </table>

      </form>

      <div class="d-flex ml-md-4 mr-n4">
        {% set link_class = 'd-block no-underline border rounded-2 px-4 pt-1 pb-2' %}
        {% for format in formats %}
          <div class="width-full text-center mr-4">
            <h3 class="mb-3">{{ format.title }}</h3>
            {% for swatch in swatches %}
            <a data-href="{{ format.uri }}" class="bg-{{ swatch.bg }} {{ link_class }} {{ swatch.class }}">
              <div class="text-bold text-{{ swatch.fg }} mb-2">on {{ swatch.bg }}</div>
              <img>
            </a>
            {% endfor %}
          </div>
        {% endfor %}
      </div>

    </div>

    <script>
      var form = document.getElementById('chooser')
      var links = document.querySelectorAll('a[data-href]')
      var images = document.getElementsByTagName('img')

      set('size', '{{ sizes[0] }}')
      if (location.search) {
        try {
          var params = new URL(location.href).searchParams
          Array.from(params.keys()).forEach(function(key) {
            set(key, params.get(key))
          })
        } catch (error) {
          console.warn('unable to get search params:', error)
        }
      } else {
        var colors = Array.from(document.elements.color.options)
        var hasBlack = colors.some(function(option) {
          return option.value === 'black'
        })
        set('color', hasBlack ? 'black' : colors[0].value)
      }

      update()
      form.addEventListener('change', update)

      document.addEventListener('error', function(event) {
        event.target.classList.add('border-red')
      })

      function update() {
        var values = {}
        Array.from(form.elements).forEach(function(input) {
          if (input.checked !== false) {
            values[input.name || input.id] = input.value
          }
        })
        Array.from(links).forEach(function(link) {
          var img = link.querySelector('img')
          var template = link.getAttribute('data-href')
          var url = template.replace(/{(\w+)}/g, function(_, key) {
            return values[key]
          })
          link.href = img.src = url
          img.width = values.size
        })

        updateSelected('size', values.size)

        var params = new URLSearchParams(values)
        var url = '?' + params.toString()
        history.replaceState(values, '', url)
      }

      function set(name, value) {
        Array.from(form.elements)
          .filter(function(input) {
            return input.name === name || input.id === name
          })
          .forEach(function(input) {
            if (input.type === 'radio') {
              input.checked = input.value == value
            } else {
              input.value = value
            }
          })
      }

      function updateSelected(name, value) {
        var selector = '.btn [name="' + name + '"]'
        Array.from(form.querySelectorAll(selector))
          .forEach(function(input) {
            var button = input.closest('.btn')
            button.classList.toggle('selected', input.value == value)
          })
      }

    </script>
  </body>
</html>
